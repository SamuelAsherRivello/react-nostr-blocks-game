var ze=Object.defineProperty;var Ve=(e,t,n)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var c=(e,t,n)=>Ve(e,typeof t!="symbol"?t+"":t,n);import{b as f,h as E,c as C,s as D,r as G,a as Q,e as We,d as X,f as Fe,g as R,i as k,j as je,k as Ke}from"./@noble-CxapbStt.js";import{b,a as y}from"./@scure-B8cFRZlm.js";var Ze=Object.defineProperty,d=(e,t)=>{for(var n in t)Ze(e,n,{get:t[n],enumerable:!0})},w=Symbol("verified"),Ge=e=>e instanceof Object;function Y(e){if(!Ge(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]=="object")return!1}return!0}var Qe={};d(Qe,{Queue:()=>ne,QueueNode:()=>te,binarySearch:()=>H,insertEventIntoAscendingList:()=>Ye,insertEventIntoDescendingList:()=>Xe,normalizeURL:()=>ee,utf8Decoder:()=>v,utf8Encoder:()=>p});var v=new TextDecoder("utf-8"),p=new TextEncoder;function ee(e){e.indexOf("://")===-1&&(e="wss://"+e);let t=new URL(e);return t.pathname=t.pathname.replace(/\/+/g,"/"),t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),(t.port==="80"&&t.protocol==="ws:"||t.port==="443"&&t.protocol==="wss:")&&(t.port=""),t.searchParams.sort(),t.hash="",t.toString()}function Xe(e,t){const[n,r]=H(e,i=>t.id===i.id?0:t.created_at===i.created_at?-1:i.created_at-t.created_at);return r||e.splice(n,0,t),e}function Ye(e,t){const[n,r]=H(e,i=>t.id===i.id?0:t.created_at===i.created_at?-1:t.created_at-i.created_at);return r||e.splice(n,0,t),e}function H(e,t){let n=0,r=e.length-1;for(;n<=r;){const i=Math.floor((n+r)/2),a=t(e[i]);if(a===0)return[i,!0];a<0?r=i-1:n=i+1}return[n,!1]}var te=class{constructor(e){c(this,"value");c(this,"next",null);c(this,"prev",null);this.value=e}},ne=class{constructor(){c(this,"first");c(this,"last");this.first=null,this.last=null}enqueue(e){const t=new te(e);return this.last?this.last===this.first?(this.last=t,this.last.prev=this.first,this.first.next=t):(t.prev=this.last,this.last.next=t,this.last=t):(this.first=t,this.last=t),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const t=this.first;return this.first=null,this.last=null,t.value}const e=this.first;return this.first=e.next,e.value}},et=class{generateSecretKey(){return k.utils.randomPrivateKey()}getPublicKey(e){return f(k.getPublicKey(e))}finalizeEvent(e,t){const n=e;return n.pubkey=f(k.getPublicKey(t)),n.id=P(n),n.sig=f(k.sign(P(n),t)),n[w]=!0,n}verifyEvent(e){if(typeof e[w]=="boolean")return e[w];const t=P(e);if(t!==e.id)return e[w]=!1,!1;try{const n=k.verify(e.sig,t,e.pubkey);return e[w]=n,n}catch{return e[w]=!1,!1}}};function tt(e){if(!Y(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function P(e){let t=R(p.encode(tt(e)));return f(t)}var L=new et,Hr=L.generateSecretKey,$r=L.getPublicKey,m=L.finalizeEvent,M=L.verifyEvent,nt={};d(nt,{Application:()=>nn,BadgeAward:()=>dt,BadgeDefinition:()=>Zt,BlockedRelaysList:()=>Nt,BookmarkList:()=>Mt,Bookmarksets:()=>Ft,Calendar:()=>un,CalendarEventRSVP:()=>dn,ChannelCreation:()=>oe,ChannelHideMessage:()=>ue,ChannelMessage:()=>le,ChannelMetadata:()=>ce,ChannelMuteUser:()=>de,ClassifiedListing:()=>sn,ClientAuth:()=>he,CommunitiesList:()=>Ot,CommunityDefinition:()=>pn,CommunityPostApproval:()=>Et,Contacts:()=>ot,CreateOrUpdateProduct:()=>Xt,CreateOrUpdateStall:()=>Qt,Curationsets:()=>jt,Date:()=>cn,DraftClassifiedListing:()=>on,DraftLong:()=>en,Emojisets:()=>tn,EncryptedDirectMessage:()=>ct,EncryptedDirectMessages:()=>lt,EventDeletion:()=>ut,FileMetadata:()=>pt,FileServerPreference:()=>Dt,Followsets:()=>zt,GenericRepost:()=>ht,Genericlists:()=>Vt,HTTPAuth:()=>B,Handlerinformation:()=>fn,Handlerrecommendation:()=>hn,Highlights:()=>Tt,InterestsList:()=>Ut,Interestsets:()=>Gt,JobFeedback:()=>kt,JobRequest:()=>bt,JobResult:()=>_t,Label:()=>wt,LightningPubRPC:()=>$t,LiveChatMessage:()=>vt,LiveEvent:()=>rn,LongFormArticle:()=>Yt,Metadata:()=>it,Mutelist:()=>Pt,NWCWalletInfo:()=>Ht,NWCWalletRequest:()=>fe,NWCWalletResponse:()=>Jt,NostrConnect:()=>Bt,OpenTimestamps:()=>ft,Pinlist:()=>Ct,ProblemTracker:()=>gt,ProfileBadges:()=>Kt,PublicChatsList:()=>At,Reaction:()=>J,RecommendRelay:()=>st,RelayList:()=>Lt,Relaysets:()=>Wt,Report:()=>yt,Reporting:()=>mt,Repost:()=>$,SearchRelaysList:()=>It,ShortTextNote:()=>at,Time:()=>ln,UserEmojiList:()=>qt,UserStatuses:()=>an,Zap:()=>xt,ZapGoal:()=>Rt,ZapRequest:()=>St,classifyKind:()=>rt,isEphemeralKind:()=>ae,isParameterizedReplaceableKind:()=>se,isRegularKind:()=>re,isReplaceableKind:()=>ie});function re(e){return 1e3<=e&&e<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(e)}function ie(e){return[0,3].includes(e)||1e4<=e&&e<2e4}function ae(e){return 2e4<=e&&e<3e4}function se(e){return 3e4<=e&&e<4e4}function rt(e){return re(e)?"regular":ie(e)?"replaceable":ae(e)?"ephemeral":se(e)?"parameterized":"unknown"}var it=0,at=1,st=2,ot=3,ct=4,lt=4,ut=5,$=6,J=7,dt=8,ht=16,oe=40,ce=41,le=42,ue=43,de=44,ft=1040,pt=1063,vt=1311,gt=1971,yt=1984,mt=1984,wt=1985,Et=4550,bt=5999,_t=6999,kt=7e3,Rt=9041,St=9734,xt=9735,Tt=9802,Pt=1e4,Ct=10001,Lt=10002,Mt=10003,Ot=10004,At=10005,Nt=10006,It=10007,Ut=10015,qt=10030,Dt=10096,Ht=13194,$t=21e3,he=22242,fe=23194,Jt=23195,Bt=24133,B=27235,zt=3e4,Vt=30001,Wt=30002,Ft=30003,jt=30004,Kt=30008,Zt=30009,Gt=30015,Qt=30017,Xt=30018,Yt=30023,en=30024,tn=30030,nn=30078,rn=30311,an=30315,sn=30402,on=30403,cn=31922,ln=31923,un=31924,dn=31925,hn=31989,fn=31990,pn=34550;function vn(e,t){if(e.ids&&e.ids.indexOf(t.id)===-1||e.kinds&&e.kinds.indexOf(t.kind)===-1||e.authors&&e.authors.indexOf(t.pubkey)===-1)return!1;for(let n in e)if(n[0]==="#"){let r=n.slice(1),i=e[`#${r}`];if(i&&!t.tags.find(([a,s])=>a===n.slice(1)&&i.indexOf(s)!==-1))return!1}return!(e.since&&t.created_at<e.since||e.until&&t.created_at>e.until)}function gn(e,t){for(let n=0;n<e.length;n++)if(vn(e[n],t))return!0;return!1}var yn={};d(yn,{getHex64:()=>O,getInt:()=>pe,getSubscriptionId:()=>ve,matchEventId:()=>mn,matchEventKind:()=>En,matchEventPubkey:()=>wn});function O(e,t){let n=t.length+3,r=e.indexOf(`"${t}":`)+n,i=e.slice(r).indexOf('"')+r+1;return e.slice(i,i+64)}function pe(e,t){let n=t.length,r=e.indexOf(`"${t}":`)+n+3,i=e.slice(r),a=Math.min(i.indexOf(","),i.indexOf("}"));return parseInt(i.slice(0,a),10)}function ve(e){let t=e.slice(0,22).indexOf('"EVENT"');if(t===-1)return null;let n=e.slice(t+7+1).indexOf('"');if(n===-1)return null;let r=t+7+1+n,i=e.slice(r+1,80).indexOf('"');if(i===-1)return null;let a=r+1+i;return e.slice(r+1,a)}function mn(e,t){return t===O(e,"id")}function wn(e,t){return t===O(e,"pubkey")}function En(e,t){return t===pe(e,"kind")}var bn={};d(bn,{makeAuthEvent:()=>ge});function ge(e,t){return{kind:he,created_at:Math.floor(Date.now()/1e3),tags:[["relay",e],["challenge",t]],content:""}}async function _n(){return new Promise(e=>{const t=new MessageChannel,n=()=>{t.port1.removeEventListener("message",n),e()};t.port1.addEventListener("message",n),t.port2.postMessage(0),t.port1.start()})}var ye=class{constructor(e,t){c(this,"url");c(this,"_connected",!1);c(this,"onclose",null);c(this,"onnotice",e=>console.debug(`NOTICE from ${this.url}: ${e}`));c(this,"_onauth",null);c(this,"baseEoseTimeout",4400);c(this,"connectionTimeout",4400);c(this,"openSubs",new Map);c(this,"connectionTimeoutHandle");c(this,"connectionPromise");c(this,"openCountRequests",new Map);c(this,"openEventPublishes",new Map);c(this,"ws");c(this,"incomingMessageQueue",new ne);c(this,"queueRunning",!1);c(this,"challenge");c(this,"serial",0);c(this,"verifyEvent");c(this,"_WebSocket");this.url=ee(e),this.verifyEvent=t.verifyEvent,this._WebSocket=t.websocketImplementation||WebSocket}static async connect(e,t){const n=new ye(e,t);return await n.connect(),n}closeAllSubscriptions(e){for(let[t,n]of this.openSubs)n.close(e);this.openSubs.clear();for(let[t,n]of this.openEventPublishes)n.reject(new Error(e));this.openEventPublishes.clear();for(let[t,n]of this.openCountRequests)n.reject(new Error(e));this.openCountRequests.clear()}get connected(){return this._connected}async connect(){return this.connectionPromise?this.connectionPromise:(this.challenge=void 0,this.connectionPromise=new Promise((e,t)=>{this.connectionTimeoutHandle=setTimeout(()=>{var n;t("connection timed out"),this.connectionPromise=void 0,(n=this.onclose)==null||n.call(this),this.closeAllSubscriptions("relay connection timed out")},this.connectionTimeout);try{this.ws=new this._WebSocket(this.url)}catch(n){t(n);return}this.ws.onopen=()=>{clearTimeout(this.connectionTimeoutHandle),this._connected=!0,e()},this.ws.onerror=n=>{var r;t(n.message||"websocket error"),this._connected&&(this._connected=!1,this.connectionPromise=void 0,(r=this.onclose)==null||r.call(this),this.closeAllSubscriptions("relay connection errored"))},this.ws.onclose=async()=>{var n;this._connected&&(this._connected=!1,this.connectionPromise=void 0,(n=this.onclose)==null||n.call(this),this.closeAllSubscriptions("relay connection closed"))},this.ws.onmessage=this._onmessage.bind(this)}),this.connectionPromise)}async runQueue(){for(this.queueRunning=!0;this.handleNext()!==!1;)await _n();this.queueRunning=!1}handleNext(){var n,r,i;const e=this.incomingMessageQueue.dequeue();if(!e)return!1;const t=ve(e);if(t){const a=this.openSubs.get(t);if(!a)return;const s=O(e,"id"),o=(n=a.alreadyHaveEvent)==null?void 0:n.call(a,s);if((r=a.receivedEvent)==null||r.call(a,this,s),o)return}try{let a=JSON.parse(e);switch(a[0]){case"EVENT":{const s=this.openSubs.get(a[1]),o=a[2];this.verifyEvent(o)&&gn(s.filters,o)&&s.onevent(o);return}case"COUNT":{const s=a[1],o=a[2],u=this.openCountRequests.get(s);u&&(u.resolve(o.count),this.openCountRequests.delete(s));return}case"EOSE":{const s=this.openSubs.get(a[1]);if(!s)return;s.receivedEose();return}case"OK":{const s=a[1],o=a[2],u=a[3],h=this.openEventPublishes.get(s);o?h.resolve(u):h.reject(new Error(u)),this.openEventPublishes.delete(s);return}case"CLOSED":{const s=a[1],o=this.openSubs.get(s);if(!o)return;o.closed=!0,o.close(a[2]);return}case"NOTICE":this.onnotice(a[1]);return;case"AUTH":{this.challenge=a[1],(i=this._onauth)==null||i.call(this,a[1]);return}}}catch{return}}async send(e){if(!this.connectionPromise)throw new Error("sending on closed connection");this.connectionPromise.then(()=>{var t;(t=this.ws)==null||t.send(e)})}async auth(e){if(!this.challenge)throw new Error("can't perform auth, no challenge was received");const t=await e(ge(this.url,this.challenge)),n=new Promise((r,i)=>{this.openEventPublishes.set(t.id,{resolve:r,reject:i})});return this.send('["AUTH",'+JSON.stringify(t)+"]"),n}async publish(e){const t=new Promise((n,r)=>{this.openEventPublishes.set(e.id,{resolve:n,reject:r})});return this.send('["EVENT",'+JSON.stringify(e)+"]"),t}async count(e,t){this.serial++;const n=(t==null?void 0:t.id)||"count:"+this.serial,r=new Promise((i,a)=>{this.openCountRequests.set(n,{resolve:i,reject:a})});return this.send('["COUNT","'+n+'",'+JSON.stringify(e).substring(1)),r}subscribe(e,t){const n=this.prepareSubscription(e,t);return n.fire(),n}prepareSubscription(e,t){this.serial++;const n=t.id||"sub:"+this.serial,r=new kn(this,n,e,t);return this.openSubs.set(n,r),r}close(){var e;this.closeAllSubscriptions("relay connection closed by us"),this._connected=!1,(e=this.ws)==null||e.close()}_onmessage(e){this.incomingMessageQueue.enqueue(e.data),this.queueRunning||this.runQueue()}},kn=class{constructor(e,t,n,r){c(this,"relay");c(this,"id");c(this,"closed",!1);c(this,"eosed",!1);c(this,"filters");c(this,"alreadyHaveEvent");c(this,"receivedEvent");c(this,"onevent");c(this,"oneose");c(this,"onclose");c(this,"eoseTimeout");c(this,"eoseTimeoutHandle");this.relay=e,this.filters=n,this.id=t,this.alreadyHaveEvent=r.alreadyHaveEvent,this.receivedEvent=r.receivedEvent,this.eoseTimeout=r.eoseTimeout||e.baseEoseTimeout,this.oneose=r.oneose,this.onclose=r.onclose,this.onevent=r.onevent||(i=>{console.warn(`onevent() callback not defined for subscription '${this.id}' in relay ${this.relay.url}. event received:`,i)})}fire(){this.relay.send('["REQ","'+this.id+'",'+JSON.stringify(this.filters).substring(1)),this.eoseTimeoutHandle=setTimeout(this.receivedEose.bind(this),this.eoseTimeout)}receivedEose(){var e;this.eosed||(clearTimeout(this.eoseTimeoutHandle),this.eosed=!0,(e=this.oneose)==null||e.call(this))}close(e="closed by caller"){var t;!this.closed&&this.relay.connected&&(this.relay.send('["CLOSE",'+JSON.stringify(this.id)+"]"),this.closed=!0),this.relay.openSubs.delete(this.id),(t=this.onclose)==null||t.call(this,e)}},me;try{me=WebSocket}catch{}var Rn=class extends ye{constructor(e){super(e,{verifyEvent:M,websocketImplementation:me})}static async connect(e){const t=new Rn(e);return await t.connect(),t}},Sn;try{Sn=WebSocket}catch{}var xn={};d(xn,{BECH32_REGEX:()=>we,Bech32MaxSize:()=>z,decode:()=>A,encodeBytes:()=>N,naddrEncode:()=>An,neventEncode:()=>On,noteEncode:()=>Ln,nprofileEncode:()=>Mn,npubEncode:()=>Cn,nrelayEncode:()=>Nn,nsecEncode:()=>Pn});var z=5e3,we=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function Tn(e){const t=new Uint8Array(4);return t[0]=e>>24&255,t[1]=e>>16&255,t[2]=e>>8&255,t[3]=e&255,t}function A(e){var i,a,s,o,u,h,g,x;let{prefix:t,words:n}=b.decode(e,z),r=new Uint8Array(b.fromWords(n));switch(t){case"nprofile":{let l=T(r);if(!((i=l[0])!=null&&i[0]))throw new Error("missing TLV 0 for nprofile");if(l[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:f(l[0][0]),relays:l[1]?l[1].map(_=>v.decode(_)):[]}}}case"nevent":{let l=T(r);if(!((a=l[0])!=null&&a[0]))throw new Error("missing TLV 0 for nevent");if(l[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(l[2]&&l[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(l[3]&&l[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:f(l[0][0]),relays:l[1]?l[1].map(_=>v.decode(_)):[],author:(s=l[2])!=null&&s[0]?f(l[2][0]):void 0,kind:(o=l[3])!=null&&o[0]?parseInt(f(l[3][0]),16):void 0}}}case"naddr":{let l=T(r);if(!((u=l[0])!=null&&u[0]))throw new Error("missing TLV 0 for naddr");if(!((h=l[2])!=null&&h[0]))throw new Error("missing TLV 2 for naddr");if(l[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((g=l[3])!=null&&g[0]))throw new Error("missing TLV 3 for naddr");if(l[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:v.decode(l[0][0]),pubkey:f(l[2][0]),kind:parseInt(f(l[3][0]),16),relays:l[1]?l[1].map(_=>v.decode(_)):[]}}}case"nrelay":{let l=T(r);if(!((x=l[0])!=null&&x[0]))throw new Error("missing TLV 0 for nrelay");return{type:"nrelay",data:v.decode(l[0][0])}}case"nsec":return{type:t,data:r};case"npub":case"note":return{type:t,data:f(r)};default:throw new Error(`unknown prefix ${t}`)}}function T(e){let t={},n=e;for(;n.length>0;){let r=n[0],i=n[1],a=n.slice(2,2+i);if(n=n.slice(2+i),a.length<i)throw new Error(`not enough data to read on TLV ${r}`);t[r]=t[r]||[],t[r].push(a)}return t}function Pn(e){return N("nsec",e)}function Cn(e){return N("npub",E(e))}function Ln(e){return N("note",E(e))}function S(e,t){let n=b.toWords(t);return b.encode(e,n,z)}function N(e,t){return S(e,t)}function Mn(e){let t=I({0:[E(e.pubkey)],1:(e.relays||[]).map(n=>p.encode(n))});return S("nprofile",t)}function On(e){let t;e.kind!==void 0&&(t=Tn(e.kind));let n=I({0:[E(e.id)],1:(e.relays||[]).map(r=>p.encode(r)),2:e.author?[E(e.author)]:[],3:t?[new Uint8Array(t)]:[]});return S("nevent",n)}function An(e){let t=new ArrayBuffer(4);new DataView(t).setUint32(0,e.kind,!1);let n=I({0:[p.encode(e.identifier)],1:(e.relays||[]).map(r=>p.encode(r)),2:[E(e.pubkey)],3:[new Uint8Array(t)]});return S("naddr",n)}function Nn(e){let t=I({0:[p.encode(e)]});return S("nrelay",t)}function I(e){let t=[];return Object.entries(e).reverse().forEach(([n,r])=>{r.forEach(i=>{let a=new Uint8Array(i.length+2);a.set([parseInt(n)],0),a.set([i.length],1),a.set(i,2),t.push(a)})}),C(...t)}var In={};d(In,{decrypt:()=>Un,encrypt:()=>Ee});async function Ee(e,t,n){const r=e instanceof Uint8Array?f(e):e,i=D.getSharedSecret(r,"02"+t),a=be(i);let s=Uint8Array.from(G(16)),o=p.encode(n),u=Q(a,s).encrypt(o),h=y.encode(new Uint8Array(u)),g=y.encode(new Uint8Array(s.buffer));return`${h}?iv=${g}`}async function Un(e,t,n){const r=e instanceof Uint8Array?f(e):e;let[i,a]=n.split("?iv="),s=D.getSharedSecret(r,"02"+t),o=be(s),u=y.decode(a),h=y.decode(i),g=Q(o,u).decrypt(h);return v.decode(g)}function be(e){return e.slice(1,33)}var qn={};d(qn,{NIP05_REGEX:()=>_e,isValid:()=>$n,queryProfile:()=>ke,searchDomain:()=>Hn,useFetchImplementation:()=>Dn});var _e=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,U;try{U=fetch}catch{}function Dn(e){U=e}async function Hn(e,t=""){try{const n=`https://${e}/.well-known/nostr.json?name=${t}`;return(await(await U(n,{redirect:"error"})).json()).names}catch{return{}}}async function ke(e){var a;const t=e.match(_e);if(!t)return null;const[n,r="_",i]=t;try{const s=`https://${i}/.well-known/nostr.json?name=${r}`,o=await(await U(s,{redirect:"error"})).json();let u=o.names[r];return u?{pubkey:u,relays:(a=o.relays)==null?void 0:a[u]}:null}catch{return null}}async function $n(e,t){let n=await ke(t);return n?n.pubkey===e:!1}var Jn={};d(Jn,{parse:()=>Bn});function Bn(e){const t={reply:void 0,root:void 0,mentions:[],profiles:[]},n=[];for(const r of e.tags)r[0]==="e"&&r[1]&&n.push(r),r[0]==="p"&&r[1]&&t.profiles.push({pubkey:r[1],relays:r[2]?[r[2]]:[]});for(let r=0;r<n.length;r++){const i=n[r],[a,s,o,u]=i,h={id:s,relays:o?[o]:[]},g=r===0,x=r===n.length-1;if(u==="root"){t.root=h;continue}if(u==="reply"){t.reply=h;continue}if(u==="mention"){t.mentions.push(h);continue}if(g){t.root=h;continue}if(x){t.reply=h;continue}t.mentions.push(h)}return t}var zn={};d(zn,{fetchRelayInformation:()=>Wn,useFetchImplementation:()=>Vn});var Re;try{Re=fetch}catch{}function Vn(e){Re=e}async function Wn(e){return await(await fetch(e.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var Fn={};d(Fn,{getPow:()=>Se,minePow:()=>jn});function Se(e){let t=0;for(let n=0;n<e.length;n++){const r=parseInt(e[n],16);if(r===0)t+=4;else{t+=Math.clz32(r)-28;break}}return t}function jn(e,t){let n=0;const r=e,i=["nonce",n.toString(),t.toString()];for(r.tags.push(i);;){const a=Math.floor(new Date().getTime()/1e3);if(a!==r.created_at&&(n=0,r.created_at=a),i[1]=(++n).toString(),r.id=P(r),Se(r.id)>=t)break}return r}var Kn={};d(Kn,{finishRepostEvent:()=>Zn,getRepostedEvent:()=>Gn,getRepostedEventPointer:()=>xe});function Zn(e,t,n,r){return m({kind:$,tags:[...e.tags??[],["e",t.id,n],["p",t.pubkey]],content:e.content===""?"":JSON.stringify(t),created_at:e.created_at},r)}function xe(e){if(e.kind!==$)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){const i=e.tags[r];i.length>=2&&(i[0]==="e"&&t===void 0?t=i:i[0]==="p"&&n===void 0&&(n=i))}if(t!==void 0)return{id:t[1],relays:[t[2],n==null?void 0:n[2]].filter(r=>typeof r=="string"),author:n==null?void 0:n[1]}}function Gn(e,{skipVerification:t}={}){const n=xe(e);if(n===void 0||e.content==="")return;let r;try{r=JSON.parse(e.content)}catch{return}if(r.id===n.id&&!(!t&&!M(r)))return r}var Qn={};d(Qn,{NOSTR_URI_REGEX:()=>q,parse:()=>Yn,test:()=>Xn});var q=new RegExp(`nostr:(${we.source})`);function Xn(e){return typeof e=="string"&&new RegExp(`^${q.source}$`).test(e)}function Yn(e){const t=e.match(new RegExp(`^${q.source}$`));if(!t)throw new Error(`Invalid Nostr URI: ${e}`);return{uri:t[0],value:t[1],decoded:A(t[1])}}var er={};d(er,{finishReactionEvent:()=>tr,getReactedEventPointer:()=>nr});function tr(e,t,n){const r=t.tags.filter(i=>i.length>=2&&(i[0]==="e"||i[0]==="p"));return m({...e,kind:J,tags:[...e.tags??[],...r,["e",t.id],["p",t.pubkey]],content:e.content??"+"},n)}function nr(e){if(e.kind!==J)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){const i=e.tags[r];i.length>=2&&(i[0]==="e"&&t===void 0?t=i:i[0]==="p"&&n===void 0&&(n=i))}if(!(t===void 0||n===void 0))return{id:t[1],relays:[t[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var rr={};d(rr,{matchAll:()=>ir,regex:()=>V,replaceAll:()=>ar});var V=()=>new RegExp(`\\b${q.source}\\b`,"g");function*ir(e){const t=e.matchAll(V());for(const n of t)try{const[r,i]=n;yield{uri:r,value:i,decoded:A(i),start:n.index,end:n.index+r.length}}catch{}}function ar(e,t){return e.replaceAll(V(),(n,r)=>t({uri:n,value:r,decoded:A(r)}))}var sr={};d(sr,{channelCreateEvent:()=>or,channelHideMessageEvent:()=>ur,channelMessageEvent:()=>lr,channelMetadataEvent:()=>cr,channelMuteUserEvent:()=>dr});var or=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return m({kind:oe,tags:[...e.tags??[]],content:n,created_at:e.created_at},t)},cr=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return m({kind:ce,tags:[["e",e.channel_create_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},lr=(e,t)=>{const n=[["e",e.channel_create_event_id,e.relay_url,"root"]];return e.reply_to_channel_message_event_id&&n.push(["e",e.reply_to_channel_message_event_id,e.relay_url,"reply"]),m({kind:le,tags:[...n,...e.tags??[]],content:e.content,created_at:e.created_at},t)},ur=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return m({kind:ue,tags:[["e",e.channel_message_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},dr=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return m({kind:de,tags:[["p",e.pubkey_to_mute],...e.tags??[]],content:n,created_at:e.created_at},t)},hr={};d(hr,{EMOJI_SHORTCODE_REGEX:()=>Te,matchAll:()=>fr,regex:()=>W,replaceAll:()=>pr});var Te=/:(\w+):/,W=()=>new RegExp(`\\B${Te.source}\\B`,"g");function*fr(e){const t=e.matchAll(W());for(const n of t)try{const[r,i]=n;yield{shortcode:r,name:i,start:n.index,end:n.index+r.length}}catch{}}function pr(e,t){return e.replaceAll(W(),(n,r)=>t({shortcode:n,name:r}))}var vr={};d(vr,{useFetchImplementation:()=>gr,validateGithub:()=>yr});var F;try{F=fetch}catch{}function gr(e){F=e}async function yr(e,t,n){try{return await(await F(`https://gist.github.com/${t}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${e}`}catch{return!1}}var mr={};d(mr,{decrypt:()=>Ne,encrypt:()=>Ae,getConversationKey:()=>Le,v2:()=>kr});var Pe=1,Ce=65535;function Le(e,t){const n=D.getSharedSecret(e,"02"+t).subarray(1,33);return We(R,n,"nip44-v2")}function Me(e,t){const n=je(R,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function j(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;const t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function wr(e){if(!Number.isSafeInteger(e)||e<Pe||e>Ce)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function Er(e){const t=p.encode(e),n=t.length,r=wr(n),i=new Uint8Array(j(n)-n);return C(r,t,i)}function br(e){const t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<Pe||t>Ce||n.length!==t||e.length!==2+j(t))throw new Error("invalid padding");return v.decode(n)}function Oe(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=C(n,t);return Ke(R,e,r)}function _r(e){if(typeof e!="string")throw new Error("payload must be a valid string");const t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=y.decode(e)}catch(a){throw new Error("invalid base64: "+a.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const i=n[0];if(i!==2)throw new Error("unknown encryption version "+i);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function Ae(e,t,n=G(32)){const{chacha_key:r,chacha_nonce:i,hmac_key:a}=Me(t,n),s=Er(e),o=X(r,i,s),u=Oe(a,o,n);return y.encode(C(new Uint8Array([2]),n,o,u))}function Ne(e,t){const{nonce:n,ciphertext:r,mac:i}=_r(e),{chacha_key:a,chacha_nonce:s,hmac_key:o}=Me(t,n),u=Oe(o,r,n);if(!Fe(u,i))throw new Error("invalid MAC");const h=X(a,s,r);return br(h)}var kr={utils:{getConversationKey:Le,calcPaddedLen:j},encrypt:Ae,decrypt:Ne},Rr={};d(Rr,{makeNwcRequestEvent:()=>xr,parseConnectionString:()=>Sr});function Sr(e){const{pathname:t,searchParams:n}=new URL(e),r=t,i=n.get("relay"),a=n.get("secret");if(!r||!i||!a)throw new Error("invalid connection string");return{pubkey:r,relay:i,secret:a}}async function xr(e,t,n){const i=await Ee(t,e,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),a={kind:fe,created_at:Math.round(Date.now()/1e3),content:i,tags:[["p",e]]};return m(a,t)}var Tr={};d(Tr,{getZapEndpoint:()=>Cr,makeZapReceipt:()=>Or,makeZapRequest:()=>Lr,useFetchImplementation:()=>Pr,validateZapRequest:()=>Mr});var K;try{K=fetch}catch{}function Pr(e){K=e}async function Cr(e){try{let t="",{lud06:n,lud16:r}=JSON.parse(e.content);if(n){let{words:s}=b.decode(n,1e3),o=b.fromWords(s);t=v.decode(o)}else if(r){let[s,o]=r.split("@");t=new URL(`/.well-known/lnurlp/${s}`,`https://${o}`).toString()}else return null;let a=await(await K(t)).json();if(a.allowsNostr&&a.nostrPubkey)return a.callback}catch{}return null}function Lr({profile:e,event:t,amount:n,relays:r,comment:i=""}){if(!n)throw new Error("amount not given");if(!e)throw new Error("profile not given");let a={kind:9734,created_at:Math.round(Date.now()/1e3),content:i,tags:[["p",e],["amount",n.toString()],["relays",...r]]};return t&&a.tags.push(["e",t]),a}function Mr(e){let t;try{t=JSON.parse(e)}catch{return"Invalid zap request JSON."}if(!Y(t))return"Zap request is not a valid Nostr event.";if(!M(t))return"Invalid signature on zap request.";let n=t.tags.find(([a,s])=>a==="p"&&s);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=t.tags.find(([a,s])=>a==="e"&&s);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":t.tags.find(([a,s])=>a==="relays"&&s)?null:"Zap request doesn't have a 'relays' tag."}function Or({zapRequest:e,preimage:t,bolt11:n,paidAt:r}){let i=JSON.parse(e),a=i.tags.filter(([o])=>o==="e"||o==="p"||o==="a"),s={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...a,["P",i.pubkey],["bolt11",n],["description",e]]};return t&&s.tags.push(["preimage",t]),s}var Ar={};d(Ar,{getToken:()=>Nr,hashPayload:()=>Z,unpackEventFromToken:()=>Ue,validateEvent:()=>Be,validateEventKind:()=>De,validateEventMethodTag:()=>$e,validateEventPayloadTag:()=>Je,validateEventTimestamp:()=>qe,validateEventUrlTag:()=>He,validateToken:()=>Ir});var Ie="Nostr ";async function Nr(e,t,n,r=!1,i){const a={kind:B,tags:[["u",e],["method",t]],created_at:Math.round(new Date().getTime()/1e3),content:""};i&&a.tags.push(["payload",Z(i)]);const s=await n(a);return(r?Ie:"")+y.encode(p.encode(JSON.stringify(s)))}async function Ir(e,t,n){const r=await Ue(e).catch(a=>{throw a});return await Be(r,t,n).catch(a=>{throw a})}async function Ue(e){if(!e)throw new Error("Missing token");e=e.replace(Ie,"");const t=v.decode(y.decode(e));if(!t||t.length===0||!t.startsWith("{"))throw new Error("Invalid token");return JSON.parse(t)}function qe(e){return e.created_at?Math.round(new Date().getTime()/1e3)-e.created_at<60:!1}function De(e){return e.kind===B}function He(e,t){const n=e.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===t:!1}function $e(e,t){const n=e.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===t.toLowerCase():!1}function Z(e){const t=R(p.encode(JSON.stringify(e)));return f(t)}function Je(e,t){const n=e.tags.find(i=>i[0]==="payload");if(!n)return!1;const r=Z(t);return n.length>0&&n[1]===r}async function Be(e,t,n,r){if(!M(e))throw new Error("Invalid nostr event, signature invalid");if(!De(e))throw new Error("Invalid nostr event, kind invalid");if(!qe(e))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!He(e,t))throw new Error("Invalid nostr event, url tag invalid");if(!$e(e,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!Je(e,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}export{Rn as R,$r as a,m as f,Hr as g,In as n,M as v};
